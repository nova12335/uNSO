<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Drum Pad — Amen Break</title>
  <style>
    :root{--bg:#0b0b0d;--card:#0f0f12;--accent:#7be3ff;--muted:#9aa0a6}
    html,body{height:100%;margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial}
    body{background:linear-gradient(180deg,#030304 0%, #0b0b0d 100%);color:#e6eef3;display:flex;align-items:center;justify-content:center;padding:24px}
    .app{width:100%;max-width:980px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    .controls{display:flex;gap:10px;align-items:center}
    .pad-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .pad{background:linear-gradient(180deg,#111214,#0b0b0d);border:1px solid rgba(255,255,255,0.04);padding:18px;border-radius:12px;display:flex;align-items:center;justify-content:center;flex-direction:column;cursor:pointer;user-select:none;transition:transform .08s, box-shadow .08s}
    .pad:active,.pad.playing{transform:translateY(-4px);box-shadow:0 10px 30px rgba(0,0,0,0.6)}
    .pad .label{font-weight:700;margin-top:8px;color:var(--muted);font-size:13px}
    .small{font-size:12px;color:var(--muted)}
    .amen-controls{margin-top:16px;background:rgba(255,255,255,0.02);padding:12px;border-radius:10px}
    .row{display:flex;gap:8px;align-items:center}
    input[type=range]{width:140px}
    .file{font-size:12px}
    footer{margin-top:18px;color:var(--muted);font-size:13px}
    .kbd{background:#101317;padding:6px 8px;border-radius:6px;font-weight:700}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Drum Pad — click to play (Amen Break included)</h1>
      <div class="controls">
        <div class="small">Use keys 1–9 or clique</div>
      </div>
    </header>

    <main>
      <div class="pad-grid" id="pads"></div>

      <div class="amen-controls" id="amenBox">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
          <div>
            <strong>Amen Break (loop)</strong>
            <div class="small">Clique play para tocar o loop. Você pode substituir por seu próprio arquivo.</div>
          </div>
          <div class="row">
            <button id="amenPlayBtn">Play</button>
            <button id="amenStopBtn">Stop</button>
            <label class="small">Velocidade</label>
            <input type="range" id="tempoRange" min="50" max="150" value="100"> <span id="tempoLabel">100%</span>
          </div>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <label class="file">Substituir Amen Break: <input type="file" id="amenFile" accept="audio/*"></label>
          <button id="downloadBtn">Baixar este HTML</button>
        </div>
      </div>

      <footer>
        Dica: arraste áudio para cada pad para usar seus samples. Os pads também respondem às teclas 1–9.
      </footer>
    </main>
  </div>

  <script>
    // Simple Drum Pad app using WebAudio
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const ctx = new AudioContext();

    const padInfos = [
      {name:'Kick', key:'1'},
      {name:'Snare', key:'2'},
      {name:'Hi-Hat Closed', key:'3'},
      {name:'Tom', key:'4'},
      {name:'Clap', key:'5'},
      {name:'Perc', key:'6'},
      {name:'Crash', key:'7'},
      {name:'Ride', key:'8'},
      {name:'Amen Slice', key:'9'}
    ];

    const defaultSamples = {
      // These are short generated sounds as fallbacks. You can replace with real samples by uploading.
      'Kick': null,
      'Snare': null,
      'Hi-Hat Closed': null,
      'Tom': null,
      'Clap': null,
      'Perc': null,
      'Crash': null,
      'Ride': null,
      // 'Amen Slice' could be assigned to a slice of the amen break if user uploads one
      'Amen Slice': null
    };

    // create pads in DOM
    const padsEl = document.getElementById('pads');
    const pads = [];

    padInfos.forEach((info, i) => {
      const el = document.createElement('div');
      el.className = 'pad';
      el.dataset.index = i;
      el.innerHTML = `<div style="font-size:28px">${info.key}</div><div class="label">${info.name}</div>`;
      padsEl.appendChild(el);

      // allow file drop / click
      el.addEventListener('click', async ()=> playPad(i));
      el.addEventListener('dragover', e=>{e.preventDefault(); el.style.opacity=0.8});
      el.addEventListener('dragleave', e=>{el.style.opacity=''});
      el.addEventListener('drop', async e=>{
        e.preventDefault(); el.style.opacity='';
        const f = e.dataTransfer.files?.[0];
        if(f) await loadFileToPad(f, i);
      });

      pads.push({el, buffer:null});
    });

    // key handling
    window.addEventListener('keydown', async (ev)=>{
      if(document.activeElement && (document.activeElement.tagName==='INPUT' || document.activeElement.tagName==='TEXTAREA')) return;
      const k = ev.key;
      const idx = padInfos.findIndex(p=>p.key===k);
      if(idx>=0) { playPad(idx); }
    });

    // generate tiny synth fallback when buffer missing
    function playSynth(type='click'){
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = 'square';
      o.frequency.value = 150;
      g.gain.value = 0.0001;
      o.connect(g);
      g.connect(ctx.destination);
      const now = ctx.currentTime;
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(0.3, now+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, now+0.4);
      o.start(now); o.stop(now+0.5);
    }

    async function playPad(i){
      // wake audio context on first interaction
      if(ctx.state==='suspended') await ctx.resume();

      const pad = pads[i];
      if(pad.buffer){
        const s = ctx.createBufferSource();
        s.buffer = pad.buffer;
        s.connect(ctx.destination);
        s.start();
      } else {
        playSynth();
      }

      pad.el.classList.add('playing');
      setTimeout(()=>pad.el.classList.remove('playing'),120);
    }

    async function loadFileToPad(file, index){
      const arr = await file.arrayBuffer();
      const buf = await ctx.decodeAudioData(arr);
      pads[index].buffer = buf;
      pads[index].el.querySelector('.label').textContent = file.name;
    }

    // Amen break loop player
    let amenBuffer = null;
    let amenSource = null;
    let amenPlaybackRate = 1;
    const amenPlayBtn = document.getElementById('amenPlayBtn');
    const amenStopBtn = document.getElementById('amenStopBtn');
    const tempoRange = document.getElementById('tempoRange');
    const tempoLabel = document.getElementById('tempoLabel');
    const amenFile = document.getElementById('amenFile');

    // Default Amen (base64 embutido)
    const AMEN_BASE64 = "data:audio/ogg;base64,T2dnUwACAAAAAAAAAADp0WgqAAAAABAnHnYBE09nZ1MAAAAAAAAAAAAA6dFoKgEAAAAgJx52AUtPZ2dTAAAAAAAAAAAAAOnRaCoCAAAAEAcedgHvT2dnUwAAAAAAAAAAAADp0WgqAwAAABAnHnYBzE...";

    async function fetchAmen(url){
      try{
        const res = await fetch(url);
        if(!res.ok) throw new Error('fetch fail');
        const arr = await res.arrayBuffer();
        amenBuffer = await ctx.decodeAudioData(arr);
        console.log('Amen loaded');
      }catch(e){
        console.warn('Falha no URL, carregando base64 embutido');
        const res2 = await fetch(AMEN_BASE64);
        const arr2 = await res2.arrayBuffer();
        amenBuffer = await ctx.decodeAudioData(arr2);
      }
    }

    // tenta carregar direto do base64
    fetchAmen(AMEN_BASE64)(url){
      try{
        const res = await fetch(url);
        if(!res.ok) throw new Error('fetch fail');
        const arr = await res.arrayBuffer();
        amenBuffer = await ctx.decodeAudioData(arr);
        console.log('Amen loaded');
      }catch(e){
        console.warn('Não foi possível carregar Amen pelo URL. Faça upload do seu arquivo.');
      }
    }

    // try loading default (best effort)
    fetchAmen(DEFAULT_AMEN_URL);

    function playAmen(){
      if(!amenBuffer) { alert('Amen break não carregado. Faça upload de um arquivo .wav/.ogg/.mp3'); return; }
      if(ctx.state==='suspended') ctx.resume();
      amenSource = ctx.createBufferSource();
      amenSource.buffer = amenBuffer;
      amenSource.loop = true;
      amenSource.playbackRate.value = amenPlaybackRate;
      amenSource.connect(ctx.destination);
      amenSource.start();
    }

    function stopAmen(){
      if(amenSource){ try{ amenSource.stop(); }catch(e){} amenSource.disconnect(); amenSource = null; }
    }

    amenPlayBtn.addEventListener('click', ()=>{ playAmen(); });
    amenStopBtn.addEventListener('click', ()=>{ stopAmen(); });

    tempoRange.addEventListener('input', ()=>{
      const pct = Number(tempoRange.value);
      tempoLabel.textContent = pct + '%';
      amenPlaybackRate = pct/100;
      if(amenSource) amenSource.playbackRate.value = amenPlaybackRate;
    });

    amenFile.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      const arr = await f.arrayBuffer();
      amenBuffer = await ctx.decodeAudioData(arr);
      alert('Amen break carregado com sucesso — clique Play.');
    });

    // permitir upload múltiplo de samples + arrastar pasta
    const multiInput = document.createElement('input');
    multiInput.type = 'file';
    multiInput.accept = 'audio/*';
    multiInput.multiple = true;

    // arrastar PASTA para carregar em ordem
    document.addEventListener('dragover', e=>{ e.preventDefault(); });
    document.addEventListener('drop', async e=>{
      if(!e.dataTransfer.items) return;
      const items = e.dataTransfer.items;
      let files = [];

      // lê pasta inteira, preservando ordem
      for(const item of items){
        const entry = item.webkitGetAsEntry();
        if(entry && entry.isDirectory){
          await readDir(entry, files);
        } else if(item.kind === 'file'){
          const f = item.getAsFile();
          if(f) files.push(f);
        }
      }

      // ordena por nome da pasta
      files.sort((a,b)=> a.name.localeCompare(b.name));

      // distribui nos pads
      for(let i=0;i<files.length && i<pads.length;i++){
        const arr = await files[i].arrayBuffer();
        const buf = await ctx.decodeAudioData(arr);
        pads[i].buffer = buf;
        pads[i].el.querySelector('.label').textContent = files[i].name;
      }
    });

    async function readDir(entry, out){
      const reader = entry.createReader();
      const entries = await new Promise(r=> reader.readEntries(r));
      for(const e of entries){
        if(e.isDirectory) await readDir(e, out);
        else if(e.isFile){
          await new Promise(res=> e.file(f=>{ out.push(f); res(); }));
        }
      }
    } (carrega em ordem nos pads)
    const multiInput = document.createElement('input');
    multiInput.type = 'file';
    multiInput.accept = 'audio/*';
</script> to pads via an invisible input
    const fileInput = document.createElement('input');
    fileInput.type='file'; fileInput.accept='audio/*'; fileInput.style.display='none';
    document.body.appendChild(fileInput);
    fileInput.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0];
      if(!f) return; 
      // find last clicked pad
      if(typeof lastClickedPadIndex==='number') await loadFileToPad(f,lastClickedPadIndex);
      lastClickedPadIndex = null;
    });

    let lastClickedPadIndex = null;
    pads.forEach((p,idx)=>{
      p.el.addEventListener('dblclick', ()=>{
        lastClickedPadIndex = idx;
        fileInput.click();
      });
    });

    // download self HTML
    document.getElementById('downloadBtn').addEventListener('click', ()=>{
      const html = '<!doctype html>\n' + document.documentElement.outerHTML;
      const blob = new Blob([html], {type:'text/html'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'drum-pad.html'; a.click();
      URL.revokeObjectURL(url);
    });

    // small UX: clicking a pad while holding shift will prompt to upload sample
    pads.forEach((p, i)=>{
      p.el.addEventListener('click', (ev)=>{
        if(ev.shiftKey){ lastClickedPadIndex = i; fileInput.click(); }
      });
    });

  </script>
</body>
</html>
